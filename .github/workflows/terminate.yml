
name: Terminate EC2 Instance

on:
  workflow_run:
    workflows: ["Launch EC2 Instance"]  # Must match the name of your launch workflow
    types:
      - completed

jobs:
  terminate-ec2:
    runs-on: ubuntu-latest

    steps:
      - name: Download Instance ID Artifact
        uses: actions/download-artifact@v4
        with:
          name: ec2-instance-id

      - name: Read Instance ID
        run: |
          INSTANCE_ID=$(cat instance-id.txt)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Validate Instance ID
        run: |
          echo "Validating instance: ${{ env.INSTANCE_ID }}"
          if aws ec2 describe-instances --instance-ids "${{ env.INSTANCE_ID }}" >/dev/null 2>&1; then
            echo "Instance exists. Proceeding to terminate."
          else
            echo "Instance ${{ env.INSTANCE_ID }} does not exist or is already terminated."
            exit 0

      - name: Terminate EC2 Instance
        run: |
          echo "Terminating EC2 instance: ${{ env.INSTANCE_ID }}"
          aws ec2 terminate-instances --instance-ids "${{ env.INSTANCE_ID }}"
          echo "Terminate API call sent for ${{ env.INSTANCE_ID }}"

      - name: Wait until instance is terminated
        run: |
          echo "Waiting for instance ${{ env.INSTANCE_ID }} to terminate..."
          aws ec2 wait instance-terminated --instance-ids "${{ env.INSTANCE_ID }}"
          echo "Instance ${{ env.INSTANCE_ID }} is fully terminated."
